#!/usr/bin/env bash
#
# Arquivo: sf-vite
# DescriÃ§Ã£o: Scaffolding de um projeto usando o Vite.js
#
# Mais um script feito com ðŸ’™ por "Lucas SaliÃ©s Brum" <lucas@archlinux.com.br>
# Demo: https://www.gettr.com/post/pgjgwb394b
# 
# Criado em: 23/09/2021 01:33:12
# Atualizado: 09/11/2021 19:33:12
#
# ReferÃªncia de cores:
# FG: reset = 0, black = 30, red = 31, green = 32, yellow = 33, blue = 34, magenta = 35, cyan = 36, white = 37
# BG: reset = 0, black = 40, red = 41, green = 42, yellow = 43, blue = 44, magenta = 45, cyan = 46, white=47

command -v dialog &> /dev/null || (echo -e "O programa \e[1;31mdialog\e[0m nÃ£o estÃ¡ instalado, instale-o primeiro." && exit)
command -v pnpm &> /dev/null || (echo -e "O programa \e[1;31mpnpm\e[0m nÃ£o estÃ¡ instalado, instale-o primeiro." && exit)

EDITOR="${VISUAL:-code}"
BROWSER="${BROWSER:-firefox}"
REGEX="^[a-zA-Z0-9.-]+$"

[ ! -d $HOME/.config/dialog/ ] && mkdir -p $HOME/.config/dialog/
[ ! -f $HOME/.config/dialog/amarelo.cfg ] && curl -s -L http://ix.io/3EtV -o $HOME/.config/dialog/amarelo.cfg
export DIALOGRC=$HOME/.config/dialog/amarelo.cfg

NOME="$(dialog --stdout --keep-tite --backtitle 'Vite.js Scaffolding' --title 'Vite.js' --inputbox 'Digite o nome do projeto:' 0 0 'vitejs-app' 2>&1)"
[ $? -ne 0 ] && exit

if [[ ! "$NOME" =~ $REGEX ]]; then
    timeout --foreground 5 dialog --keep-tite --backtitle "Vite.js Scaffolding" --title "Vite.js" --msgbox "O caminho \e[1;31m${NOME}\e[0m Ã© invÃ¡lido." 10 30
    exit 1
fi

if test -d ${NOME}; then
  dialog \
    --keep-tite \
    --title 'AVISO' \
    --yesno "\nExiste um diretÃ³rio com o nome ${NOME}\n
              Quer sobreescrever?\n\n" \
    0 0
    [ $? -ne 0 ] && exit

    mv ${NOME} ${NOME}-$(date +%s)
fi

TIPO=$(dialog --stdout --keep-tite \
  --backtitle "Vite.js Scaffolding" \
  --title "Vite.js" \
  --radiolist "Escolha template" 17 45 50 \
    "Vue Bootstrap" "" ON \
    "Vanilla" "" OFF \
    "Vanilla TS" "" OFF \
    "Vue" "" OFF \
    "Vue TS" "" OFF \
    "React" "" OFF \
    "React TS" "" OFF \
    "Preact" "" OFF \
    "Preact TS" "" OFF \
    "Lit" "" OFF \
    "Lit TS" "" OFF \
    "Svelte" "" OFF \
    "Svelte TS" "" OFF 2>&1)

case $TIPO in
  "Vue Bootstrap") tipo="vue" subtipo="bootstrap" ;;
  "Vanilla") tipo="vanilla" ;;
  "Vanilla TS") tipo="vanilla-ts" ;;
  "Vue") tipo="vue" ;;
  "Vue TS") tipo="vue-ts" ;;
  "React") tipo="react" ;;
  "React TS") tipo="react-ts" ;;
  "Preact") tipo="preact" ;;
  "Preact TS") tipo="preact-ts" ;;
  "Lit") tipo="lit" ;;
  "Lit TS") tipo="lit-ts" ;;
  "Svelte") tipo="svelte" ;;
  "Svelte TS") tipo="svelte-ts" ;;
  *) exit ;;
esac

pnpm create vite ${NOME} -- --template ${tipo}

if [ $? -eq 0 ]; then
    cd ${NOME}

    test -d .vscode || /usr/bin/mkdir .vscode
    test -d .github/workflows || /usr/bin/mkdir -p .github/workflows

    test -f .vscode/settings.json || \
        curl -sL -o .vscode/settings.json \
        https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/0c9ebd51b30060a623eddab6573dabff9f62fb16/settings.json

    test -f .vscode/tasks.json || \
        curl -sL -o .vscode/tasks.json \
        https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/0c9ebd51b30060a623eddab6573dabff9f62fb16/tasks.json

    test -f .github/workflows/vite.yml || \
        curl -sL -o .github/workflows/vite.yml \
        https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/0c9ebd51b30060a623eddab6573dabff9f62fb16/vite.yml        

    pnpm install

    if [ ! -z "$subtipo" ]; then
        test -d public/css || /usr/bin/mkdir -p public/css
        
        test -f index.html && mv index.html index-$(date +%s).html
        curl -sL -o index.html \
            https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/febf72d3cfc64a33bbc3b808d14c78d780e926e9/index.html

        test -f src/main.js && mv src/main.js src/main-$(date +%s).js
        curl -sL -o src/main.js \
            https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/63fbfff90e64ebab9b808bfb9b64e03806b20e88/main.js

        test -f public/css/base.css && mv public/css/base.css public/css/base-$(date +%s).css
        curl -sL -o public/css/base.css \
            https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/0c9ebd51b30060a623eddab6573dabff9f62fb16/base.css

        test -f public/css/cover.css || rm -f public/css/cover.css
        curl -sL -o public/css/cover.css \
            https://getbootstrap.com/docs/5.1/examples/cover/cover.css

        test -f src/App.vue || rm -f src/App.vue
        curl -sL -o src/App.vue \
            https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/075774d46873d3332cc2616da70ad7f84db44019/App.vue

        test -f src/components/HelloWorld.vue && rm -f src/components/HelloWorld.vue
        
        test -f src/components/Main.vue && rm -f src/components/Main.vue
        curl -sL -o src/components/Main.vue \
            https://gist.githubusercontent.com/sistematico/96c9dda44e7bcea42210e9477ebffeaf/raw/e581c0912e9df91567613bfa2149671217d25a73/Main.vue

        pnpm install bootstrap
        pnpm install @popperjs/core
    fi

    $EDITOR .
    # $BROWSER http://localhost:3000
else
    echo "Houve um erro na instalaÃ§Ã£o."
fi